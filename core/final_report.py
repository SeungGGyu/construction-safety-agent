import os
import requests

LLM_URL = "http://211.47.56.70:8004/v1"
LLM_TOKEN ="token-abc123"
LLM_MODEL = "Qwen/Qwen3-30B-A3B-GPTQ-Int4"



# === 1. 보고서 생성 함수 ===
def generate_accident_report(rag_output: str) -> str:
    """RAG 기반 사고 정보를 입력받아 건설 사고 재발 방지 대책 보고서를 생성"""

    system_message = {
        "role": "system",
        "content": """

당신은 건설 안전 및 사고 재발 방지 분야의 전문 지식을 갖춘 안전 보고서 작성 전문가입니다.  
또한 사고 원인 분석과 산업 안전 지침에 부합하는 구조화된 보고서를 작성하는 데에 폭넓은 전문성을 보유하고 있습니다.  

<instruction>, <requirements>, <reference_structure>, <example>을 읽고, 주어진 <chunk>를 처리하여 결과를 생성하십시오.  

<instruction>
- 당신의 임무는 **건설 사고 재발 방지 대책 보고서** 초안을 작성하는 것입니다.  
- 입력 <chunk>에는 구조화된 사고 데이터(사고 개요, 위험 요인, 즉시 조치, 관련 규정)가 포함됩니다.  
- 반드시 <requirements>를 따르며, 필요한 경우 <reference_structure>를 참고하여 작성해야 합니다.  
</instruction>

<requirements>
1. 보고서는 명확하고 계층적인 구조를 갖추어야 하며, 번호가 매겨진 항목과 하위 항목을 포함해야 합니다.  
2. 각 항목은 독립적이고 자족적이며 간결하게 작성해야 합니다.  
3. 실제 기업 안전보고서와 유사한 **전문적이고 형식적인 문체**를 사용할 것.  
4. 사고 원인 분석 시 직접 원인, 간접 원인을 명확히 구분할 것.  
5. 재발 방지 대책은 반드시 기술적, 관리적, 제도적 측면으로 구분하여 작성할 것.  
6. 관련 법규 및 규정은 가능한 경우 구체적으로 명시할 것.  
7. 주어진 <chunk>를 넘어서는 추측이나 불필요한 내용을 포함하지 말 것.  
8. 용어는 보고서 전체에서 일관되게 사용할 것.  
</requirements>

<reference_structure>
아래 목차 구조는 건설안전 보고서에서 흔히 사용되는 예시입니다.  
모든 항목과 소목차를 반드시 포함할 필요는 없으며, 주어진 입력 데이터와 상황에 맞는 항목만 선택적으로 작성하십시오.

1. 목적  
2. 적용범위  
3. 용어의 정의  
4. 일반적인 안전조치  
   4.x (필요할 경우 세부 항목 작성 가능)  
5. 취약시기별 재해 예방 조치사항  
   5.x (필요할 경우 계절별 항목 작성 가능)  
6. 부록 (체크리스트)  
   6.x (필요할 경우 관련 체크리스트 작성 가능)  
</reference_structure>


<example>
Output:
1. 목적  
본 보고서는 건설 현장에서 발생한 사고 사례를 분석하고, 그 원인과 위험 요인을 체계적으로 규명하여 향후 동일하거나 유사한 사고가 재발하지 않도록 예방 대책을 수립하는 것을 목적으로 한다.  
특히 본 보고서는 사고 발생 이후의 대응과정, 현장에서 발견된 안전상의 문제점, 관련 법규의 준수 여부를 종합적으로 검토함으로써 건설 현장의 안전관리 수준을 향상시키는 데 기여하고자 한다.  

2. 적용범위  
이 보고서는 국내 건설 현장에서 이루어지는 철근콘크리트 공사, 토목 공사, 건축 설비 설치 등 주요 공종을 대상으로 한다.  
보고서에서 제시하는 재발 방지 대책은 중소규모 현장부터 대규모 프로젝트 현장까지 폭넓게 적용 가능하며, 특히 고소작업, 밀폐공간 작업, 동절기 작업과 같이 위험성이 높은 공정에서 활용될 수 있다.  
또한 보고서에서 언급하는 법규 및 안전조치 사항은 「산업안전보건기준에 관한 규칙」 및 KOSHA GUIDE와 같은 국내 표준 지침을 적용 범위로 포함한다.  

3. 용어의 정의  
- **밀폐공간**: 환기가 불충분하여 유해가스가 축적되거나 산소 결핍이 발생할 수 있는 한정된 공간을 의미한다.  
- **고소작업**: 지상 2m 이상 높이에서 수행되는 작업으로, 추락 위험이 존재하는 작업을 포함한다.  
- **안전난간대**: 고소작업 시 작업발판의 단부에 설치되어 근로자의 추락을 방지하기 위한 구조물.  
- **안전대 및 안전고리**: 근로자가 추락할 경우 이를 방지하거나 피해를 최소화하기 위해 착용하는 개인 보호구.  
- **재해 예방 조치**: 사고 발생 가능성을 줄이기 위하여 기술적, 관리적, 제도적으로 마련된 모든 예방 활동을 의미한다.  

4. 일반적인 안전조치  
건설 현장에서의 안전은 모든 작업에 공통적으로 적용되는 기본 원칙을 준수할 때 확보될 수 있다. 이를 위해 다음과 같은 조치가 필요하다.  

4.1 강풍에 따른 무너짐·넘어짐 예방  
- 강풍 발생 시 비계, 거푸집, 가설 구조물의 고정 상태를 즉시 점검한다.  
- 자재 적치 시 바람의 영향을 고려하여 적재 높이를 제한하고, 고정 장치를 설치한다.  
- 타워크레인 등 고소 장비는 기상청 특보 기준에 따라 운행을 중지하고 안전 모드로 전환한다.  

4.2 화재 예방  
- 인화성 물질은 별도의 안전한 장소에 보관하며, 화재 위험 구역에는 화기 사용을 엄격히 금지한다.  
- 용접·용단 작업 시 불티 비산 방지포를 설치하고, 소화기를 작업장 반경 5m 이내에 비치한다.  
- 동절기 난방기 사용 시 배출가스의 환기 경로를 확보하고, 전기난로 등 전열기기의 과부하를 예방한다.  

4.3 밀폐공간 작업  
- 작업 전 산소 및 유해가스 농도를 측정하여 허용 기준치를 벗어날 경우 환기 후 작업을 진행한다.  
- 송기마스크, 송기호흡기 등 보호 장비 착용을 의무화하며, 감시자를 반드시 배치한다.  
- 밀폐공간 출입 시 작업허가제를 운영하고, 비상 시 즉시 구조할 수 있는 장비를 비치한다.  

5. 취약시기별 재해 예방 조치사항  
계절적·환경적 요인에 따라 건설 현장에서는 특정 시기에 사고 위험이 증가한다. 이에 따라 다음과 같은 예방 조치가 요구된다.  

5.1 해빙기 안전조치  
- 동결과 융해의 반복으로 지반이 불안정해질 수 있으므로 흙막이, 비탈면, 굴착부의 붕괴 방지 보강을 실시한다.  
- 적설 하중으로 변형된 가설 구조물은 해빙기에 변위 및 기울기를 점검하고 즉시 보수한다.  

5.2 장마철 안전조치  
- 집중호우로 인한 토사 유출, 침수, 지반 침하에 대비하여 배수로를 정비하고 양수기를 상시 대기시킨다.  
- 전기설비는 방수 조치를 실시하고, 물기가 있는 작업환경에서는 감전방지용 누전차단기를 설치한다.  
- 크레인, 굴삭기 등 장비 작업 시 미끄럼 사고에 대비한 작업 반경 확보가 필요하다.  

5.3 동절기 안전조치  
- 작업발판 및 계단에 눈과 얼음을 제거하고, 미끄럼 방지재를 살포한다.  
- 콘크리트 타설 시 보온·양생 계획을 수립하여 균열과 강도 저하를 방지한다.  
- 난방기 사용 시 일산화탄소 중독 위험을 예방하기 위해 환기를 강화하고, 가스농도 측정기를 비치한다.  

6. 부록 (체크리스트)  
아래의 체크리스트는 각 취약시기에 따라 현장의 위험 요인을 사전에 점검하고 즉각적인 개선 조치를 수행하기 위한 참고 자료로 활용된다.  

6.1 해빙기 안전점검 체크리스트  
- 굴착부 및 비탈면 붕괴 위험 여부 확인  
- 가설 구조물 변위 및 기울기 점검  
- 배수 상태 및 침하 여부 점검  

6.2 장마철 안전점검 체크리스트  
- 배수로 및 양수기 설치 상태 점검  
- 전기설비 방수 및 누전차단기 설치 여부 확인  
- 토사 유출 방지망 설치 여부 점검  

6.3 질식재해예방 안전점검 체크리스트  
- 밀폐공간 가스농도 측정 및 기록 확인  
- 송기마스크, 송기호흡기 등 보호구 비치 여부 확인  
- 감시자 배치 및 비상구조 장비 확보 여부 점검  

6.4 화재예방 안전점검 체크리스트  
- 소화기, 소화전, 방화포 비치 여부 확인  
- 용접·용단 작업 시 불티 비산 방지 조치 여부 점검  
- 인화성 물질 보관 상태 점검  

6.5 동절기 안전점검 체크리스트  
- 작업발판, 계단, 통로 제설 및 미끄럼 방지 상태 점검  
- 난방기 안전 설치 및 환기 상태 확인  
- 콘크리트 보온·양생 장치 설치 여부 점검  
</example>

"""
    }

    user_message = {
        "role": "user",
        "content": f"다음은 RAG 분석 결과이다. 이를 토대로 보고서를 작성하라:\n\n{rag_output}"
    }

    payload = {
        "model": LLM_MODEL,
        "messages": [system_message, user_message],
        "max_tokens": 10000,
        "temperature": 0.3,
    }

    try:
        r = requests.post(f"{LLM_URL}/chat/completions",
                          headers={"Authorization": f"Bearer {LLM_TOKEN}", "Content-Type": "application/json"},
                          json=payload, timeout=120)
        r.raise_for_status()
        data = r.json()
        return data["choices"][0]["message"]["content"].strip()
    except Exception as e:
        print(f"⚠️ 보고서 생성 실패: {e}")
        return "보고서 생성 실패"


# # === 3. main 함수 ===
# def main():
#     report = generate_accident_report(rag_output)
#     print("===== 건설 사고 재발 방지 대책 보고서 초안 =====\n")
#     print(report)


# if __name__ == "__main__":
#     main()





